var game={onload:function(){me.video.init(640,480,{parent:"screen",scale:"auto",scaleMethod:"flex"})?(!0===me.utils.getUriFragment().debug&&me.device.onReady(function(){me.plugin.register.defer(this,me.debug.Panel,"debug",me.input.KEY.V)}),me.audio.init("mp3,ogg"),me.loader.preload(game.resources,this.loaded.bind(this))):alert("Your browser does not support HTML5 canvas.")},loaded:function(){me.pool.register("board",game.Board),me.state.set(me.state.PLAY,new game.PlayScreen),me.state.change(me.state.PLAY)},resources:[{name:"pieces",type:"image",src:"data/img/pieces.png"}]};game.Board=me.Renderable.extend({init:function(){this.turnOwner=game.PieceColor.BLACK,this.borderPaddingX=4,this.borderPaddingY=4,this.squares=[],me.Renderable.prototype.init.apply(this,[me.game.viewport.width/2,me.game.viewport.height/2,320,320]);var e,i=this.width/8,t=this.height/8,s=-this.width/2+i/2,a=s,o=-this.height/2+t/2;for(r=0;r<8;++r){for(this.squares.push([]),c=0;c<8;++c)e=(r+c)%2==0?"#fff":"#000",e=new game.Square(this.pos.x+a,this.pos.y+o,i,t,e,r,c),me.game.world.addChild(e,1),this.squares[r].push(e),a+=i;o+=t,a=s}this.player1=new game.Player(game.PieceColor.WHITE,this),this.player2=new game.Player(game.PieceColor.BLACK,this),this.switchTurnOwner()},update:function(e){return me.Renderable.prototype.update.apply(this,[e]),!0},draw:function(e){e.setColor("#444"),e.fillRect(this.pos.x-this.borderPaddingX,this.pos.y-this.borderPaddingY,this.width+2*this.borderPaddingX,this.height+2*this.borderPaddingY)},getSquare:function(e,i){return e<0||i<0||e>=this.squares.length||i>=this.squares[e].length?null:this.squares[e][i]},getClosestSquare:function(e,t){var s,a=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,r=-1,n=-1;for(i=0;i<this.squares.length;++i)(s=Math.abs(e-this.squares[0][i].pos.x+this.squares[0][i].width/2))<a&&(a=s,n=i),(s=Math.abs(t-this.squares[i][0].pos.y+this.squares[i][0].height/2))<o&&(o=s,r=i);return this.getSquare(r,n)},switchTurnOwner:function(){switch(this.turnOwner){case game.PieceColor.WHITE:this.turnOwner=game.PieceColor.BLACK,this.player2.startTurn(),this.calculateMoves();break;case game.PieceColor.BLACK:this.turnOwner=game.PieceColor.WHITE,this.player1.startTurn(),this.calculateMoves()}},calculateMoves:function(){for(var e,i=[],t=0;t<this.squares.length;++t)for(var s=0;s<this.squares[t].length;++s)this.squares[t][s].threats=[],null!=(e=this.squares[t][s].piece)&&i.push(e);i.forEach(function(e,i){e.behavior.calculateMoves()}),i.forEach(function(e,i){e.behavior.pruneMoves()})}}),game.Grave=me.Renderable.extend({init:function(e,i,t,s,a,o,r){me.Renderable.prototype.init.apply(this,[e,i,t,s]),this.color=a,this.row=o,this.column=r,this.piece=null,this.borderPaddingX=2,this.borderPaddingY=2},update:function(){return!1},draw:function(e){e.setColor("#444"),e.fillRect(this.pos.x,this.pos.y,this.width,this.height),e.setColor(this.color),e.fillRect(this.pos.x+this.borderPaddingX,this.pos.y+this.borderPaddingY,this.width-2*this.borderPaddingX,this.height-2*this.borderPaddingY)},isOccupied:function(){return null!=this.piece},isLocatedAt:function(e,i){return this.row===i&&this.column===e},addPiece:function(e){1!=this.isOccupied()&&(e.pos.x=this.pos.x-e.width/2,e.pos.y=this.pos.y-e.height/2+e.offsetY,e.pos.z=this.row+2,e.square.piece=null,e.square=null,this.piece=e,me.game.world.sort(!0))}}),game.Graveyard=me.Renderable.extend({init:function(e,i,t,s,a,o){var n;this.numRows=a,this.numColumns=o,this.borderPaddingX=2,this.borderPaddingY=2,this.graves=[],this.graveIndex=0,me.Renderable.prototype.init.apply(this,[e,i,t,s]);var h=t/this.numColumns,u=s/this.numRows,p=-t/2+h/2,l=p,m=-this.height/2+u/2;for(r=0;r<this.numRows;++r){for(c=0;c<this.numColumns;++c)n=new game.Grave(this.pos.x+l,this.pos.y+m,h,u,"#aaa",r,c),me.game.world.addChild(n,1),this.graves.push(n),l+=h;m+=u,l=p}},update:function(e){return me.Renderable.prototype.update.apply(this,[e]),!0},draw:function(e){e.setColor("#444"),e.fillRect(this.pos.x+this.borderPaddingX,this.pos.y+this.borderPaddingY,this.width-2*this.borderPaddingX,this.height-2*this.borderPaddingY)},addPiece:function(e){this.graveIndex>=this.graves.length||(this.graves[this.graveIndex].addPiece(e),this.graveIndex++)},isEmpty:function(){return 0==this.graveIndex}}),game.Move=me.Entity.extend({init:function(e,i,t){me.Entity.prototype.init.apply(this,[0,0,{width:0,height:0}]),this.from=e,this.to=i,this.type=t,this.piece=this.from.piece,this.target=this.to.piece},equals:function(e){return this.to.equals(e.to)&&this.from.equals(e.from)}}),game.Move.Capture=game.Move.extend({init:function(e,i){game.Move.prototype.init.apply(this,[e,i,game.MoveType.CAPTURE]),this.to.threats.push(this.piece)}}),game.Move.Castle=game.Move.extend({init:function(e,i,t,s){game.Move.prototype.init.apply(this,[e,i,game.MoveType.CASTLE]),this.rookFrom=t,this.rookTo=s,this.target=this.rookFrom.piece}}),game.Move.Default=game.Move.extend({init:function(e,i){game.Move.prototype.init.apply(this,[e,i,game.MoveType.DEFAULT]),this.to.threats.push(this.piece)}}),game.Move.Enpassant=game.Move.extend({init:function(e,i,t){game.Move.prototype.init.apply(this,[e,i,game.MoveType.ENPASSANT]),this.enpassant=t,this.target=this.enpassant.piece}}),game.Square=me.Renderable.extend({init:function(e,i,t,s,a,o,r){me.Renderable.prototype.init.apply(this,[e,i,t,s]),this.color=a,this.row=o,this.column=r,this.piece=null,this.threats=[]},draw:function(e){e.setColor(this.color),e.fillRect(this.pos.x,this.pos.y,this.width,this.height)},update:function(){return!1},isOccupied:function(){return null!=this.piece},isLocatedAt:function(e,i){return this.row===i&&this.column===e},isOnRank:function(e,i){switch(i){case game.PieceColor.WHITE:return this.row===8-e;case game.PieceColor.BLACK:return this.row===e-1}return!1},isThreatened:function(i){return 0<this.threats.filter(function(e){return e.color!=i}).length},equals:function(e){return this.row===e.row&&this.column===e.column}}),game.PieceType={PAWN:0,ROOK:1,KNIGHT:2,BISHOP:3,QUEEN:4,KING:5},game.PieceColor={BLACK:0,WHITE:1},game.MoveType={DEFAULT:0,MOVE:1,CAPTURE:2,CASTLE:3},game.PieceState={IDLE:0,HELD:1,DEAD:2},game.Piece=me.DraggableEntity.extend({init:function(e,i,t){me.DraggableEntity.prototype.init.apply(this,[0,0,{image:"pieces",width:64,height:64}]),this.player=e,this.offsetY=-20,this.moveCount=0,this.setTypeAndColor(i,t)},update:function(e){return me.DraggableEntity.prototype.update.apply(this,[e]),!0},setTypeAndColor:function(e,i){this.type=e,this.color=i,this.choosePieceImage(e,i),this.setBehavior(e)},choosePieceImage:function(e,i){this.renderable.addAnimation("idle",[2*e+i],1),this.renderable.setCurrentAnimation("idle")},setBehavior:function(e){switch(e){case game.PieceType.PAWN:this.behavior=new game.Behavior.Pawn(this);break;case game.PieceType.ROOK:this.behavior=new game.Behavior.Rook(this);break;case game.PieceType.KNIGHT:this.behavior=new game.Behavior.Knight(this);break;case game.PieceType.BISHOP:this.behavior=new game.Behavior.Bishop(this);break;case game.PieceType.QUEEN:this.behavior=new game.Behavior.Queen(this);break;case game.PieceType.KING:this.behavior=new game.Behavior.King(this)}},setPieceState:function(e){var i,t=this.state;switch(this.state=e,this.state){case game.PieceState.IDLE:t==game.PieceState.HELD&&(i=this.player.board.getClosestSquare(this.pos.x-(this.square.width-this.width)/2,this.pos.y-((this.square.height-this.height)/2+this.offsetY)),this.behavior.moveToSquare(i));break;case game.PieceState.HELD:this.pos.z=50,me.game.world.sort(!0);break;case game.PieceState.DEAD:this.player.graveyard.addPiece(this)}},isHeld:function(){return this.state==game.PieceState.HELD},isDead:function(){return this.state==game.PieceState.DEAD},isColor:function(e){return this.color==e},hasMoved:function(){return 0<this.moveCount},initEvents:function(){me.DraggableEntity.prototype.initEvents.apply(this),this.removePointerEvent("pointerdown",this),this.removePointerEvent("pointerup",this),this.mouseDown=function(e){return this.player.isTurnOwner()&&this.translatePointerEvent(e,me.event.DRAGSTART),!1},this.mouseUp=function(e){return this.player.isTurnOwner()&&this.translatePointerEvent(e,me.event.DRAGEND),!1},this.onPointerEvent("pointerdown",this,this.mouseDown.bind(this)),this.onPointerEvent("pointerup",this,this.mouseUp.bind(this))},dragStart:function(e){this.isDead()||this.player.isPromotingPawn()?this.player.isPromotingPawn()&&this.type!=game.PieceType.PAWN&&this.type!=game.PieceType.KING&&(this.player.finishPawnPromotion(this.type),this.player.endTurn()):(this.setPieceState(game.PieceState.HELD),me.DraggableEntity.prototype.dragStart.apply(this,[e]))},dragEnd:function(e){this.isDead()||(this.setPieceState(game.PieceState.IDLE),me.DraggableEntity.prototype.dragEnd.apply(this,[e]))}}),game.Behavior=me.Entity.extend({init:function(e){me.Entity.prototype.init.apply(this,[0,0,{width:0,height:0}]),this.piece=e,this.moves=[]},moveToSquare:function(e){e=this.getMove(e);null!=e?(this.performMove(e),this.finishMove()):this.moveBack()},performMove:function(e){e.type===game.MoveType.CASTLE?(m.target.behavior.positionOnSquare(m.rookTo),m.rookFrom.piece=null):null!=e.target&&e.target.setPieceState(game.PieceState.DEAD),e.from.piece=null,this.positionOnSquare(e.to)},finishMove:function(){this.piece.player.endTurn()},moveBack:function(){this.positionOnSquare(this.piece.square)},positionOnSquare:function(e){null!=this.piece.square&&this.piece.square!=e&&(this.piece.moveCount++,this.piece.sinceMove=0),this.piece.pos.x=e.pos.x-this.piece.width/2,this.piece.pos.y=e.pos.y-this.piece.height/2+this.piece.offsetY,this.piece.pos.z=e.row+2,this.piece.square=e,this.piece.square.piece=this.piece,me.game.world.sort(!0)},getMove:function(i){return this.moves.find(function(e){return e.to.equals(i)})},calculateMoves:function(){this.moves=[]},pruneMoves:function(){var t=[];this.moves.forEach(function(e,i){null!=e.target&&e.target.color==e.piece.color||t.push(e)}),this.moves=t}}),game.Behavior.Bishop=game.Behavior.extend({init:function(e){game.Behavior.prototype.init.apply(this,[e])},calculateMoves:function(){var e;for(this.moves=[],e=this.getDiagonalSquares(-1,-1),i=0;i<e.length;++i)this.moves.push(new game.Move.Default(this.piece.square,e[i]));for(e=this.getDiagonalSquares(-1,1),i=0;i<e.length;++i)this.moves.push(new game.Move.Default(this.piece.square,e[i]));for(e=this.getDiagonalSquares(1,-1),i=0;i<e.length;++i)this.moves.push(new game.Move.Default(this.piece.square,e[i]));for(e=this.getDiagonalSquares(1,1),i=0;i<e.length;++i)this.moves.push(new game.Move.Default(this.piece.square,e[i]))},getDiagonalSquares:function(e,i){if(1!=Math.abs(e)&&1!=Math.abs(i))return[];for(var t,s=[],a=this.piece.square.row,o=this.piece.square.column;null!=(t=this.piece.player.board.getSquare(a+=i,o+=e))&&(s.push(t),!t.isOccupied()););return s}}),game.Behavior.King=game.Behavior.extend({init:function(e){game.Behavior.prototype.init.apply(this,[e])},calculateMoves:function(){var e,i=this.piece.player.board;this.moves=[],null!=(e=this.getAdjacentSquare(1,0))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getAdjacentSquare(-1,0))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getAdjacentSquare(0,-1))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getAdjacentSquare(0,1))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getAdjacentSquare(-1,-1))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getAdjacentSquare(-1,1))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getAdjacentSquare(1,-1))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getAdjacentSquare(1,1))&&this.moves.push(new game.Move.Default(this.piece.square,e)),e=i.getSquare(this.piece.square.row,this.piece.square.column-2),rookFromSquare=i.getSquare(this.piece.square.row,0),rookToSquare=i.getSquare(this.piece.square.row,this.piece.square.column-1),null!=e&&null!=rookFromSquare&&null!=rookToSquare&&this.moves.push(new game.Move.Castle(this.piece.square,e,rookFromSquare,rookToSquare)),e=i.getSquare(this.piece.square.row,this.piece.square.column+2),rookFromSquare=i.getSquare(this.piece.square.row,7),rookToSquare=i.getSquare(this.piece.square.row,this.piece.square.column+1),null!=e&&null!=rookFromSquare&&null!=rookToSquare&&this.moves.push(new game.Move.Castle(this.piece.square,e,rookFromSquare,rookToSquare))},pruneMoves:function(){var n=[],h=this.piece.player.board;this.moves.forEach(function(e,i){if(e.type===game.MoveType.CASTLE){var t,s=!1;if((s=0!=e.piece.moveCount||null==e.target||e.target.color!=e.piece.color||e.target.type!=game.PieceType.ROOK||0!=e.target.moveCount||e.from.isThreatened(e.piece.color)?!0:s)||(7==e.rookFrom.column?t=1:0==e.rookFrom.column?t=-1:(console.error("column is "+e.rookFrom.column+", it must be 7 or 0."),s=!0)),!s){var a,o=e.piece.square.column,r=e.piece.square.row;for(o+=t;o!=e.rookFrom.column;){if((a=h.getSquare(r,o)).isOccupied()){s=!0;break}if(a.isThreatened(e.piece.color)){s=!0;break}o+=t}}s||n.push(e)}else e.to.isThreatened(e.piece.color)||null!=e.target&&e.target.color==e.piece.color||n.push(e)}),this.moves=n},getAdjacentSquare:function(e,i){if(1<Math.abs(e)||1<Math.abs(i))return null;i=this.piece.square.row+i,e=this.piece.square.column+e,e=this.piece.player.board.getSquare(i,e);return null!=e&&(!e.isOccupied()||e.piece.color!=this.piece.color)?e:null}}),game.Behavior.Knight=game.Behavior.extend({init:function(e){game.Behavior.prototype.init.apply(this,[e])},calculateMoves:function(){var e;this.moves=[],null!=(e=this.getLSquare(2,-1))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getLSquare(2,1))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getLSquare(-2,-1))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getLSquare(-2,1))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getLSquare(1,-2))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getLSquare(-1,-2))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getLSquare(1,2))&&this.moves.push(new game.Move.Default(this.piece.square,e)),null!=(e=this.getLSquare(-1,2))&&this.moves.push(new game.Move.Default(this.piece.square,e))},getLSquare:function(e,i){if(!(2==Math.abs(e)&&1==Math.abs(i)||2==Math.abs(i)&&1==Math.abs(e)))return null;i=this.piece.square.row+i,e=this.piece.square.column+e;return this.piece.player.board.getSquare(i,e)}}),game.Behavior.Pawn=game.Behavior.extend({init:function(e){game.Behavior.prototype.init.apply(this,[e])},finishMove:function(){this.piece.square.isOnRank(8,this.piece.color)?this.piece.player.startPawnPromotion(this.piece):game.Behavior.prototype.finishMove.apply(this)},calculateMoves:function(){var e,i,t;switch(this.moves=[],this.piece.color){case game.PieceColor.WHITE:t=-1;break;case game.PieceColor.BLACK:t=1}e=this.piece.player.board.getSquare(this.piece.square.row+t,this.piece.square.column-1),i=this.piece.player.board.getSquare(this.piece.square.row,this.piece.square.column-1),null!=e&&(this.moves.push(new game.Move.Capture(this.piece.square,e)),null!=i&&this.moves.push(new game.Move.Enpassant(this.piece.square,e,i))),e=this.piece.player.board.getSquare(this.piece.square.row+t,this.piece.square.column+1),i=this.piece.player.board.getSquare(this.piece.square.row,this.piece.square.column+1),null!=e&&(this.moves.push(new game.Move.Capture(this.piece.square,e)),null!=i&&this.moves.push(new game.Move.Enpassant(this.piece.square,e,i))),null!=(e=this.piece.player.board.getSquare(this.piece.square.row+t,this.piece.square.column))&&this.moves.push(new game.Move(this.piece.square,e,game.MoveType.MOVE)),this.piece.hasMoved()||null!=(e=this.piece.player.board.getSquare(this.piece.square.row+2*t,this.piece.square.column))&&this.moves.push(new game.Move(this.piece.square,e,game.MoveType.MOVE))},pruneMoves:function(){var t=[];this.moves.forEach(function(e,i){switch(e.type){case game.MoveType.MOVE:null==e.target&&t.push(e);break;case game.MoveType.CAPTURE:null!=e.target&&e.target.color!=e.piece.color&&t.push(e);break;case game.MoveType.ENPASSANT:null!=e.target&&e.target.color!=e.piece.color&&1==e.target.moveCount&&0==e.target.sinceMove&&null==e.to.piece&&t.push(e)}}),this.moves=t}}),game.Behavior.Queen=game.Behavior.extend({init:function(e){game.Behavior.prototype.init.apply(this,[e])},calculateMoves:function(){var e,t;for(this.moves=[],e=this.getStraightSquares(1,0),i=0;i<e.length;++i)this.moves.push(new game.Move.Default(this.piece.square,e[i]));for(e=this.getStraightSquares(-1,0),i=0;i<e.length;++i)this.moves.push(new game.Move.Default(this.piece.square,e[i]));for(e=this.getStraightSquares(0,-1),i=0;i<e.length;++i)this.moves.push(new game.Move.Default(this.piece.square,e[i]));for(e=this.getStraightSquares(0,1),i=0;i<e.length;++i)this.moves.push(new game.Move.Default(this.piece.square,e[i]));for(t=this.getDiagonalSquares(-1,-1),i=0;i<t.length;++i)this.moves.push(new game.Move.Default(this.piece.square,t[i]));for(t=this.getDiagonalSquares(-1,1),i=0;i<t.length;++i)this.moves.push(new game.Move.Default(this.piece.square,t[i]));for(t=this.getDiagonalSquares(1,-1),i=0;i<t.length;++i)this.moves.push(new game.Move.Default(this.piece.square,t[i]));for(t=this.getDiagonalSquares(1,1),i=0;i<t.length;++i)this.moves.push(new game.Move.Default(this.piece.square,t[i]))},getStraightSquares:function(e,i){if(!(1==Math.abs(e)&&0==i||1==Math.abs(i)&&0==e))return[];for(var t,s=[],a=this.piece.square.row,o=this.piece.square.column;null!=(t=this.piece.player.board.getSquare(a+=i,o+=e))&&(s.push(t),!t.isOccupied()););return s},getDiagonalSquares:function(e,i){if(1!=Math.abs(e)&&1!=Math.abs(i))return[];for(var t,s=[],a=this.piece.square.row,o=this.piece.square.column;null!=(t=this.piece.player.board.getSquare(a+=i,o+=e))&&(s.push(t),!t.isOccupied()););return s}}),game.Behavior.Rook=game.Behavior.extend({init:function(e){game.Behavior.prototype.init.apply(this,[e])},calculateMoves:function(){var e;for(this.moves=[],e=this.getStraightSquares(1,0),i=0;i<e.length;++i)this.moves.push(new game.Move.Default(this.piece.square,e[i]));for(e=this.getStraightSquares(-1,0),i=0;i<e.length;++i)this.moves.push(new game.Move.Default(this.piece.square,e[i]));for(e=this.getStraightSquares(0,-1),i=0;i<e.length;++i)this.moves.push(new game.Move.Default(this.piece.square,e[i]));for(e=this.getStraightSquares(0,1),i=0;i<e.length;++i)this.moves.push(new game.Move.Default(this.piece.square,e[i]))},getStraightSquares:function(e,i){if(!(1==Math.abs(e)&&0==i||1==Math.abs(i)&&0==e))return[];for(var t,s=[],a=this.piece.square.row,o=this.piece.square.column;null!=(t=this.piece.player.board.getSquare(a+=i,o+=e))&&(s.push(t),!t.isOccupied()););return s}}),game.Player=me.Entity.extend({init:function(e,i){me.Entity.prototype.init.apply(this,[0,0,{width:0,height:0}]),this.color=e,this.board=i,this.pawnToPromote=null,i=this.color===game.PieceColor.WHITE?(me.game.viewport.height,me.game.viewport.width/2+240):me.game.viewport.width/2-240,this.graveyard=new game.Graveyard(i,me.game.viewport.height/2,80,320,8,2),me.game.world.addChild(this.graveyard,0),this.setPieces()},setPieces:function(){var e,t;switch(this.color){case game.PieceColor.WHITE:t=(e=7)-1;break;case game.PieceColor.BLACK:t=(e=0)+1}for(piece=new game.Piece(this,game.PieceType.ROOK,this.color),me.game.world.addChild(piece),piece.behavior.positionOnSquare(this.board.getSquare(e,0)),piece=new game.Piece(this,game.PieceType.KNIGHT,this.color),me.game.world.addChild(piece),piece.behavior.positionOnSquare(this.board.getSquare(e,1)),piece=new game.Piece(this,game.PieceType.BISHOP,this.color),me.game.world.addChild(piece),piece.behavior.positionOnSquare(this.board.getSquare(e,2)),piece=new game.Piece(this,game.PieceType.QUEEN,this.color),me.game.world.addChild(piece),piece.behavior.positionOnSquare(this.board.getSquare(e,3)),piece=new game.Piece(this,game.PieceType.KING,this.color),me.game.world.addChild(piece),piece.behavior.positionOnSquare(this.board.getSquare(e,4)),piece=new game.Piece(this,game.PieceType.BISHOP,this.color),me.game.world.addChild(piece),piece.behavior.positionOnSquare(this.board.getSquare(e,5)),piece=new game.Piece(this,game.PieceType.KNIGHT,this.color),me.game.world.addChild(piece),piece.behavior.positionOnSquare(this.board.getSquare(e,6)),piece=new game.Piece(this,game.PieceType.ROOK,this.color),me.game.world.addChild(piece),piece.behavior.positionOnSquare(this.board.getSquare(e,7)),i=0;i<8;++i)piece=new game.Piece(this,game.PieceType.PAWN,this.color),me.game.world.addChild(piece),piece.behavior.positionOnSquare(this.board.getSquare(t,i))},isTurnOwner:function(){return this.color==this.board.turnOwner},startTurn:function(){for(var e=0;e<this.board.squares.length;++e)for(var i=this.board.squares[e],t=0;t<i.length;t++){var s=i[t];s.isOccupied()&&s.piece.isColor(this.color)&&s.piece.sinceMove++}},endTurn:function(){this.board.switchTurnOwner()},startPawnPromotion:function(e){this.pawnToPromote=e},finishPawnPromotion:function(e){this.pawnToPromote.setTypeAndColor(e,this.color),this.pawnToPromote=null},isPromotingPawn:function(){return null!=this.pawnToPromote}}),game.resources=[{name:"pieces",type:"image",src:"data/img/pieces.png"}],game.PlayScreen=me.Stage.extend({onResetEvent:function(){me.game.world.addChild(new me.ColorLayer("background","#000000"),-1),me.game.world.addChild(me.pool.pull("board"),0),me.input.bindKey(me.input.KEY.LEFT,"left"),me.input.bindKey(me.input.KEY.RIGHT,"right"),me.input.bindKey(me.input.KEY.A,"left"),me.input.bindKey(me.input.KEY.D,"right")},onDestroyEvent:function(){me.input.unbindKey(me.input.KEY.LEFT),me.input.unbindKey(me.input.KEY.RIGHT),me.input.unbindKey(me.input.KEY.A),me.input.unbindKey(me.input.KEY.D)}});